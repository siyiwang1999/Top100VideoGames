setwd("/Users/wangsahyeok/Desktop/Postgraduate/MARK 5827/Individual Research Project")

telecom1<-read.csv("/Users/wangsahyeok/Desktop/Postgraduate/MARK 5827/Individual Research Project/telecom_churn.csv")

names(telecom1) 
summary(telecom1)
str(telecom1)

telecom1[2]<-lapply(telecom1[2], as.numeric)
telecom1[3]<-lapply(telecom1[3], as.factor)
telecom1[4:9]<-lapply(telecom1[4:9], as.numeric)
telecom1[10]<-lapply(telecom1[10], as.factor) 

str(telecom1)

numb.churn<-table(telecom1$Churn)  
numb.churn

barplot(numb.churn)

install.packages("survival")
library("survival")       # We need to load the survical analysis package.
install.packages("survminer")
library ("survminer") # For nice visualizations
install.packages("reshape2")
library("reshape2")       # For plotting.
install.packages("car")
library("car")

surv.obj<-Surv(telecom1$AccountWeeks, telecom1$Churn) 
surv.obj[1:10]

surv.obj[2600:2800] 

summary(surv.obj) 

summary(telecom1$AccountWeeks)
sum(telecom1$AccountWeeks == '0') # or count
telecom1$AccountWeeks[which(telecom1$AccountWeeks == 0)] <- NA
summary(telecom1$AccountWeeks)

attach(telecom1)

mod0 <- survreg(Surv(AccountWeeks, Churn) ~ 1, data = telecom1)
summary(mod0)

#draw mod0 1
surv <- seq(.99, .01, by = -.01)
t <- predict(mod0, type = "quantile", p = 1-surv, newdata = data.frame(1))
surv.df2 <- data.frame(time = t, surv=surv, upper = NA, lower = NA, std.err = NA)
ggsurvplot_df(fit = surv.df2, surv.geom = geom_line, xlim = c(0, 250), break.time.by = 50)

#drea mod0 2
require("survival")
fit <- survfit(Surv(AccountWeeks, Churn) ~ 1, data = telecom1)
ggsurvplot(fit, data = telecom1)

mod1<-survreg(Surv(AccountWeeks, Churn) ~ servicecall, data = telecom1) 
summary(mod1)
AIC(mod1)

mod2 <- survreg(Surv(AccountWeeks, Churn) ~   servicecall+ 
                  DataPlan + DayMins + OverageFee + RoamMins, data = telecom1)
summary(mod2)
vif(mod2)
AIC(mod2)

n.dat <- expand.grid(servicecall = levels(servicecall)) 
surv <- seq(.99, .01, by = -.01)

a1<-predict(mod1, type = "quantile", p = 1-surv, 
            newdata = data.frame(n.dat))
dim(a1) #2 rows and 99 columns
a1[1:2,1:10] 

a2<-cbind(n.dat, a1)

a3<-melt(a2, id.vars=c("servicecall"), variable.name="surv_id", value.name="time")
a3$surv <- surv[as.numeric(a3$surv_id)]
a3

ggsurvplot_df(a3, surv.geom = geom_line,
              linetype = "servicecall", color="servicecall", legend.title = NULL, xlim=c(0,300), break.time.by = 50)

a1[1:2,95:99] 

# First install the rms package, which is required to derive predictions for different points in time.
install.packages("rms")
library ("rms") 

# Then you have to rerun mod1 using the psm function that is equivalent to the survreg 
# function used in the tutorial
mod1_psm <- psm(Surv(AccountWeeks, Churn) ~ servicecall, data = telecom1, dist="weibull")
mod1_psm  			# This model is the same as the previous model mod1

# We produce a sequence which will define the points in time at which we want predicted survival probabilities from our model. 
weeks <- seq(1,500, by = +1)  	

# We define the levels of the variable for which we want probabilities
n.dat <- expand.grid(servicecall = levels(servicecall))

# We ask the model for predictions for 500 weeks ahead.
b1<-survest(mod1_psm, newdata = data.frame(n.dat), time=weeks)

# We rearrange the data such that we can easily use it for the cash flow predictions.
b2<-cbind(n.dat, b1) 
b3<-melt(b2, id.vars=c("servicecall"), variable.name="time", value.name="surv prob")
b3 
